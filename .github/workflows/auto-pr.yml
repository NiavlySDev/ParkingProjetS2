name: Auto PR to main

on:
  push:
    branches: [ "sylvain", "phily", "ethan", "virgile" ]

permissions:
  contents: write        # nécessaire pour merger
  pull-requests: write   # nécessaire pour créer/éditer la PR

jobs:
  pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure PR exists + enable auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          set -e
          BRANCH="${GITHUB_REF_NAME}"

          # Cherche une PR ouverte BRANCH -> main
          PR_NUMBER=$(gh pr list --head "$BRANCH" --base main --state open --json number -q '.[0].number' || true)

          # Si pas de PR, la créer (si rien à merger -> exit 0)
          if [ -z "$PR_NUMBER" ]; then
            if gh pr create \
              --head "$BRANCH" \
              --base main \
              --title "Merge ${BRANCH} -> main" \
              --body "PR automatique : ${BRANCH} -> main"
            then
              PR_NUMBER=$(gh pr list --head "$BRANCH" --base main --state open --json number -q '.[0].number')
            else
              echo "Rien à merger entre ${BRANCH} et main. OK."
              exit 0
            fi
          fi

          echo "PR #$PR_NUMBER trouvée/créée."

          # Active l'auto-merge (GitHub merge dès que CI OK + règles OK)
          # Si auto-merge n'est pas activé dans Settings, ça échouera.
          gh pr merge "$PR_NUMBER" --auto --merge
